\chapter{ドメイン認証}

いわゆるspamやマルウェアのメールは、送信元を偽装していることがあります。
利用者の多いメールサービスや、有名な企業のドメインからメールが発信されたように見せて、人間にメールを開かせる、という手法です。

このようなメールに対処するには、そのメールを送ってきたのは、発信者のドメインのメールサーバであるかを判定する方法が必要になります。
その判断材料を受信側メールサーバに提供するのが、本章で解説するドメイン認証になります。

\section{メールのドメイン認証}

メールのセキュリティ手法として、ドメイン認証があります。このドメイン認証とは、どのようなものなのでしょうか。

たとえば、yohane@uranohoshi.exampleというメールアドレスからメールが届いたとします。さて、このメールは本当に、yohane@uranohoshi.exampleというメールアドレスの持ち主から送られてきたものでしょうか。 それ以前に、uranohoshi.exampleというドメインのメールサーバから送られてきたものなのでしょうか。

メールのヘッダ情報を見れば、どこのメールサーバから送られてきたものが判断できると思うかもしれません。ですが、ヘッダ情報はメールのデータにサーバが付加する情報であり、そのサーバが自己申告したものに過ぎません。 そのため、ヘッダ情報は目安になっても信用できるかというと疑問が残ります。

そこで、メールを受信する側のメールサーバに対して、接続してきたサーバが、uranohosi.exampleドメインのメールサーバであるかの判断材料を、何らかの方法で提供します。 それは、送られてきたメールのドメインが、そのドメインのメールサーバから送られてきたかを判断する材料ということです。 そのため、このようなメールセキュリティ手法を、ドメイン認証とよびます。

\subsection{ドメイン認証の本質}

ドメイン認証を利用するのは、メールを受信する側です。そのドメイン認証の本質とは何でしょうか。 それは、受け取った側がドメイン認証の結果に従ってどのような処理をすべきか、推奨値を伝えることしかできないということです。 それに従うか、そして、ドメイン認証を行うかは、メールを受け取る側の判断に委ねられます。

メールを送信する側は情報を提供するだけ、利用するかどうかは受信側次第、という一方向性が、一般的な認証とは異なる点となります。

\subsection{ドメイン認証の種類}

メールのドメイン認証には、どのようなものがあるのでしょうか。

現在、ドメイン認証と呼ばれる企画は、SPF、DKIM、DMARCという三種類のものがあります。

SPFは、あるドメインのメールを転送しているメールサーバが、そのドメインにとって正式なメールサーバであるかという情報を提供します。 
DKIMは、メールサーバから創出されるメールに電子署名を付けることで、公開鍵の持ち主との関連を示します。 
SPFとDKIMは、それぞれ独立して利用することができます。また、SPFに対応してもDKIMに対応しないメールサービスも多くあります。

DMARCは、SPFとDKIMの両方による認証を提供していることが前提となるドメイン認証です。
正確には、認証のフレームワークではなく、SPFおよびDKIMによる認証に呂方とも失敗した場合、そのメールをどのように扱ってほしいか、という希望を受信側に伝えるものです。

\subsection{ドメイン認証とDNS}

では、どメイン認証の情報は、どのように提供するのでしょうか。

ドメイン認証の情報は、そのドメインの権威DNSから、TXTレコード情報として提供します。
uranohoshi.exampleというドメインのメールのためのドメイン認証情報は、uranohoshi.exampleドメインの権威DNSから提供してやる必要があるということです。
そのため、ドメイン認証情報の提供には、権威DNSのレコード書き換えができる権限が必須となります。

\subsection{MXレコードを利用した判定}

旧来から、権威DNSにおけるメールサーバの情報として、MXレコードがあります。このMXレコードを判定に使うことはどうなのでしょうか。

MXレコードはあるドメインのメールサーバがなにであるかを示すレコードです。
ですが、MXレコードが示すのは、そのドメインにメールを送信するときに、どのホストに接続して転送すればよいか、という情報になります。
旧来は、あるドメインでメールを送信するメールサーバと、外からメール転送を受けるメールサーバが同一である構成が多くありました。
そのため、多くのMTAでは、接続拒否の基準として、接続したサーバがMXレコードに書かれたものかを利用できる設定があります。

ですが、現在では、、メールを受信するためのサーバと、メールを送信するサーバが一致しないことも多くなりました。 スケーラビリティを考えてそうすることも多いのですが、例えば、外部のメール配送サービスを利用する場合は、送信サーバはMXに書かれていませんが、そのドメインのメールを送信する、という状況が生じます。

そのため、現在では、MXレコードをメールサーバの正当性の判断基準に使うのは難しくなっています。

\section{三種類のドメイン認証}

ドメイン認証には送信メールサーバの情報を提供するSPF、電子署名でそのドメインのメールサーバから発信されたことを証明するDKIM、そして、SPFとDKIMの両方で認証失敗したメールをどう扱うかの指針であるDMARCの三種類があります。

ドメイン認証の情報がどのように提供されているのか、それについてもう少し説明をして行きましょう。

\subsection{SPF}

SPFは、Sender Policy Frameworkの略です。簡単に説明すると、あるドメインのメールサーバで正当なものは何であるかという情報を示すものです。

SFPは、権威DNSのTXTレコードを用いて提示されます。たとえば、uranohoshi.exampleというドメインのSPFレコードは、以下のように書くことができます。

\begin{verbatim}
uranohosi.example.		3600	IN	TXT	"v=spf1 a:mail.uranohosshi.example  ipv4:192.0.2.1 ipv6:2001:db8::1 mx ~all"
\end{verbatim}

これは、uranohoshi.exampleというドメインのSPF情報になります。内容としては、SPFバージョン１で記載、以下のホストから送信されたメールは、uranohoshi.exampleから送信されたメールです、という意味です。

\begin{itemize}
  \item ホスト名mail.uranohoshi.ezampleのホスト
  \item 192.0.2.1のアドレスのホスト
  \item 2008:db8:;1のIPv6アドレスのホスト
  \ itemMXレコードに記載されたホスト
\end{itemize}

最後に、それ以外のすべてのホストは、uranohoshi.exampleのメールを送信するホストではありません、という記載になっています。

このように、SPFはメールを送信したホストの正当性を判断する情報を提供するフレームワークです。
そのため、直接接続してメールを転送してきたメールサーバの検証しかできない、という欠点があります。
これは、一度ハブになるメールサーバにメールを集め、メールを再転送するようなシステムの場合、末端ではSPFによる検証ができないということになります。

また、SPFでは、ドメインのメールを送信するメールサーバの情報を網羅する必要があります。
ですが、外部のメール配信サービスを利用している場合などは、メールサーバの網羅が難しいことがあります。
この場合は、受け取って欲しいメールでも、SPFに記載の無いサーバから発信されたという理由で送信先に拒否されることとなります。


\subsection{DKIM}

DKIM(Domeinkeys Identified Mail)は、サーバでメールに電子署名をして、署名者が提示する公開鍵で検証を行い、メーるの正当性を検証するドメイン認証です。

SPFは、DNSへの問い合わせへの応答でメールサーバがそのドメインの送信メールサーバであるかを判定することができます。
ですが、前述の通り、あくまでも接続したサーバに関してのみ判定が可能であり、内部ルーティングを含めて、メール転送で判定ができなくなる欠点がありました。


メールを転送するメールサーバは、送出するメールに対して、電子署名を行います。 その電子署名の検証には公開鍵が必要となります。その公開鍵は、ドメインの権威DNSのTXTレコードで提供されます。 受信側は、その公開鍵を利用して、電子署名を検証します。検証できれば、その公開鍵に対応する秘密鍵を持っているメールサーバが署名したメールであり、それによって認証ができたことになります。

DKIMは、ドメインの権威DNSに以下のようなTXTレコードを記載します。擬似的に名前を設定して、DKIMの情報を参照させていることに気をつけてください。

\begin{verbatim}
selector._domainkey.uranohoshi.example.  IN TXT "v=DKIM1; k=rsa ; t=y ; p=公開鍵"
\end{verbatim}

selectorは、電子署名の鍵ペアを使い分けるためのものです。メールのヘッダのｓタグと同じセレクタを持つTXTレコードを選択します。
kで指定される暗号方式は、いまのところRSAのみであり、デフォルトもRSAとなっています。 
tはテスト中か実際に判定に使用していいかを表すフラグです。
t=yであれば、テスト中なのでDKIMによる認証でメールをリジェクトしてはなりません。
ここがsであれば、電子署名の検証結果で、メールを受け取るかどうかを決定します。

DKIMは、公開鍵暗号で電子署名をします。
現在はRSAによる電子署名のみ対応しています。
このときに秘密鍵と公開鍵のペアが必要となるのですが、この鍵ペアは認証局が発行するTLS証明書ではありません。
自家製生した鍵ペアを用います。
これは、DKIMの導入を容易にするために、規格で定められています。

認証局の証明書ではありませんが、公開鍵は権威DNSで公開されるため、メールの送信者の証明に使用できる、という考えです。

DKIMは電子署名を使うので、第三者から転送されたメールの検証を行うこともできます。
たとえば、メールハブからルーティングで転送されたメールを、末端のサーバで検証することもできます。
ですが、送信側はすべてのメールに、公開鍵暗号による電子署名を行わなければならず、リソースを要します。
そのため、プロバイダのサービスでは必ずしも提供されていない場合があります。

また、認証局が発行した証明書を使用しないので、メールサーバの所有者の判定には使えない事にも注してください。

\subsection{DMARC}
DMARC(Domain based Message Authentication Reporting \& Conformance)は、ドメイン認証として単独で使用するフレームワークではありません。 SPFとDKIMの判定結果に対して、どのような扱いをすればいいかという情報を受信側に提供するフレームワークです。
また、受信側に、SPFとDKIMの両方で認証失敗したメールの統計情報と、認証に失敗したメールの情報を送信する先を示します。

具体的には、SPFによる認証とDKIMによる認証の両方とも失敗したメーるの扱いを指示します。
ただ、これはあくまでも情報提供であって、受信側に従うことを強制するものではありません。

DMARCも、権威DNSのTXTレコードで記載されます。
以下の例では紙面の都合で複数行に分けていますが、実際には1行のTXTレコードとして記載します。

\begin{verbatim}
_dmarc.uranohoshi.example.  IN TXT v=DMARC1;
       p-quarantine;
       rua=dmarc@uranohoshi.example;
       ruf=dmarc@uranohoshi.example;
\end{verbatim}

これは、SPFとDKIMで認証失敗したメールは隔離(quarantine)して、統計情報と認証失敗についての情報はどちらもdmarc@utanohoshi.example宛に送信、という内容です。

ここまで説明したように、SPFとDKIMのどちらにも対応したメールサーバが発信したメールの転送をされたとき、その経路となる全てのメールサーバで、SPFとDKIMのいずれかの認証に成功しているはずです。
直接の接続をされたメールサーバではSPFもDKIMも成功するだろうし、中継によって配信をされるサーバでも、少なくともDKIMによる認証は成功するはずです。

DMARCは、SPFとDKIMの両方の設定ができていることが、運用の前提となります。
また、受信側としての正規の運用を行う場合は、統計情報や認証失敗メールの情報を送信する機能が必要です。
そのため、送信側、受信側の双方で管理負荷が高くなり、処理のリソースも必要となります。

\subsection{DMARCの何もしない指定}

ここまで、DMARCはSPFとDKIMの設定が完了しているのが前提、という記述をしました。
ですが、権威DNSのレコードを設定する権限があり、SPFの設定を行うことができても、利用しているメールサーバがDKIMに対応していない場合があります。
このような場合は、SPFの結果のみをもってDMARC認証の結果が決まります。
このような場合、DMARCの設定がないメールサーバからのメールを受け取らないポリシーのメールサーバには、メールを送ることができなくなります。

そのため、メールセキュリティとしては宜しくないのですが、以下のようなDMARCレコードを設定して、DMARCのポリシーによるRejectを回避することがあります。

\begin{verbatim}
_dmarc  IN TXT v=DMARC1; p=none;
\end{verbatim}

これは、SPFとDKIMの両方で認証失敗したメールは、そのまま受診して欲しい、という内容になります。
実際のなりすましメールを確認するには、統計情報などの送信先メールアドレスの情報も記載します。

本来、p=noneの指定は、DMARC導入のテスト段階で使用するものです。このときは、統計情報を送ってもらって、なりすましメールの状況把握を行います。

\subsection{ドメイン認証の限界}

ドメイン認証は、あくまでも、送信元をなりすましたメールの検出のためのものです。
そのため、ドメインを取得し、ドメイン認証の設定を行った上で、そのドメインからのメールとしてspamやマルウェアなどを送信している場合は、全く会いオウすることができません。
このようなメールサーバからのメール転送は、ブラックリスト方式による排除など、別のロジックを用いることとなります。

また、ドメイン認証の情報は、あくまでも送信元になっているドメインの自己申告に過ぎません。
第三者的な基準で、メールを受け取るのか隔離するのかが決まるのではありません。
同時に、ドメイン認証はあくまでも判断基準であり、実際にメールをどのように扱うかは受信側の設定次第となります。